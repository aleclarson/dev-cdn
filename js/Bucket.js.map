{
  "version": 3,
  "file": "Bucket.js",
  "sourceRoot": "..",
  "sources": [
    "src/Bucket.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "EventStream = require './EventStream'\nhasKeys = require 'hasKeys'\ncrypto = require 'crypto'\nhuey = require 'huey'\nnoop = require 'noop'\npath = require 'path'\napp = require './app'\nlog = require './log'\nwch = require 'wch'\nfs = require './fs'\n\nsetProto = Object.setPrototypeOf\ndefaultIgnore = [\n  '.*.sw[a-z]', '*~' # vim temporary files\n  '.DS_Store'        # macOS Finder metadata\n]\n\n# Buckets are local caches for project assets.\nclass Bucket\n  constructor: (opts) ->\n    @name = opts.name\n    @root = opts.root\n    @ignore = opts.ignore or defaultIgnore\n    @assets = @_loadAssets()\n    @events = new EventStream\n    @projects = Object.create null\n    @\n\n  has: (name) ->\n    return @assets[name]?\n\n  get: (name) ->\n    if value = @assets[name]\n      value = name if value is true\n      return fs.read @_dest value\n\n  patch: (values) ->\n    for name, value of values\n\n      if value is null\n        @delete name\n        continue\n\n      prev = @assets[name]\n      @assets[name] = value\n\n      if prev\n        prev = name if prev is true\n        prev = @_dest prev\n\n        value = name if value is true\n        fs.rename prev, @_dest value\n\n      event = if prev then 'change' else 'add'\n      @events.emit event, {name, value}\n\n    @save()\n    return\n\n  put: (name) ->\n    src = path.join @root, name\n    file = fs.readFile src, null\n\n    value = @assets[name]\n    exists = value?\n\n    # Assets set to true have no content hash.\n    if value is true\n      dest = name\n    else\n      ext = path.extname name\n      dest = name.slice(0, 1 - ext.length) + sha256(file, 10) + ext\n      return if dest is value\n      @assets[name] = value = dest\n      @save()\n\n    dest = @_dest dest\n    fs.writeDir path.dirname dest if !exists\n    fs.writeFile dest, file\n\n    event = if exists then 'change' else 'add'\n    unless @loading\n      log.pale_green \"Asset #{past event}:\", huey.gray(\"/b/#{@name}/\") + name\n    @events.emit event, {name, value}\n    return\n\n  delete: (name) ->\n    if dest = @assets[name]\n      delete @assets[name]\n      @save()\n\n      dest = name if dest is true\n      dest = @_dest dest\n\n      # Jump to the bucket directory.\n      cwd = process.cwd()\n      process.chdir fs.bucketDir\n\n      # Remove the file, and its directory (if empty)\n      fs.removeFile dest\n      try fs.removeDir path.dirname(dest), false\n\n      # Return to the working directory.\n      process.chdir cwd\n\n      unless @loading\n        log.pale_pink 'Asset deleted:', huey.gray(\"/b/#{@name}/\") + name\n      @events.emit 'delete', {name}\n      return\n\n  query: (opts = {}) ->\n    opts.exclude = @ignore\n    wch.query @root, opts\n\n  save: ->\n    fs.writeJson @_dest('assets.json'), @assets\n\n  drop: (root) ->\n\n    if arguments.length\n      delete @projects[root]\n      return false if hasKeys @projects\n    else @projects = Object.create null\n\n    if log.verbose\n      log.pale_pink 'Dropping bucket:', @name\n\n    @events.unpipe()\n    @watcher.destroy()\n\n    # Jump to the bucket directory.\n    cwd = process.cwd()\n    process.chdir fs.bucketDir\n    fs.removeDir @_dest()\n\n    # Return to the working directory.\n    process.chdir cwd\n    return true\n\n  _dest: (name = '') ->\n    path.join fs.bucketDir, @name, name\n\n  _resolve: (...args) ->\n    name = path.relative @root, path.join ...args\n    if name[0] isnt '.' then name else null\n\n  _loadAssets: ->\n    bucketPath = @_dest()\n    if fs.isDir bucketPath\n      log.pale_yellow 'Loading bucket:', @name\n    else\n      log.pale_green 'New bucket:', @name, '->', @root\n      fs.writeDir bucketPath\n\n    jsonPath = @_dest 'assets.json'\n    if assets = loadAssets jsonPath\n      query = @query\n        since: fs.stat(jsonPath).mtime\n    else\n      assets = Object.create null\n      assets['assets.json'] = true\n      query = @query()\n\n    query.then (files) =>\n      @save = noop\n      @loading = true\n\n      {root} = files\n      files.forEach (file) =>\n        name = @_resolve root, file.name\n        if file.exists\n        then @put name\n        else @delete name\n\n      @loading = false\n\n      # Save even if no changes were made.\n      delete @save\n      @save()\n\n      @watcher = wch.stream root\n      .on 'data', (file) =>\n        if name = @_resolve file.path\n          if file.exists then @put name else @delete name\n\n    .catch (err) ->\n      console.error err.stack\n\n    return assets\n\nmodule.exports = Bucket\n\npast = (str) ->\n  str.replace /e?$/, 'ed'\n\nloadAssets = (jsonPath) ->\n  if fs.isFile jsonPath\n    assets = fs.readJson jsonPath\n    setProto assets, null\n    return assets\n\nsha256 = (buffer, length) ->\n\n  hash = crypto\n    .createHash 'sha256'\n    .update buffer\n    .digest 'hex'\n\n  if typeof length is 'number'\n  then hash.slice 0, length\n  else hash\n"
  ]
}